<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureFlow - Detailed Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .badge-ERROR, .badge-CRITICAL { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
        .badge-WARNING, .badge-HIGH   { background:#ffedd5; color:#9a3412; border:1px solid #fdba74; }
        .badge-MEDIUM                  { background:#fef9c3; color:#854d0e; border:1px solid #fde047; }
        .badge-LOW, .badge-INFO        { background:#dcfce7; color:#166534; border:1px solid #86efac; }
        .tab-active   { background:#6366f1; color:white; }
        .tab-inactive { background:white;   color:#6b7280; border:2px solid #e5e7eb; }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-lg mb-6 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center h-16">
            <div class="flex items-center gap-3">
                <i class="fas fa-shield-alt text-indigo-600 text-2xl"></i>
                <h1 class="text-2xl font-bold text-gray-800">
                    Secure<span class="text-indigo-600">Flow</span>
                </h1>
                <span class="px-3 py-1 text-xs font-bold text-white bg-green-500 rounded-full">v2.0</span>
            </div>
            <div class="flex gap-3">
                <a href="/" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold transition-all">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </a>
                <a href="/results" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">
                    <i class="fas fa-list"></i> Detailed Results
                </a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 pb-12">

        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-list-alt text-indigo-600"></i>
                        Detailed Security Results
                    </h2>
                    <p class="text-gray-500 mt-1">Scanned: {{ scan_time }}</p>
                </div>
                {% if report %}
                <div class="flex gap-4 flex-wrap">
                    <div class="text-center px-4 py-2 bg-indigo-50 rounded-xl">
                        <div class="text-3xl font-bold text-indigo-600">{{ report.total_findings }}</div>
                        <div class="text-xs text-gray-500 font-semibold uppercase">Total</div>
                    </div>
                    <div class="text-center px-4 py-2 bg-red-50 rounded-xl">
                        <div class="text-3xl font-bold text-red-600">{{ report.by_severity.CRITICAL }}</div>
                        <div class="text-xs text-gray-500 font-semibold uppercase">Critical</div>
                    </div>
                    <div class="text-center px-4 py-2 bg-orange-50 rounded-xl">
                        <div class="text-3xl font-bold text-orange-500">{{ report.by_severity.HIGH }}</div>
                        <div class="text-xs text-gray-500 font-semibold uppercase">High</div>
                    </div>
                    <div class="text-center px-4 py-2 bg-yellow-50 rounded-xl">
                        <div class="text-3xl font-bold text-yellow-500">{{ report.by_severity.MEDIUM }}</div>
                        <div class="text-xs text-gray-500 font-semibold uppercase">Medium</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-3 mb-6 flex-wrap">
            <button onclick="showTab('semgrep')" id="tab-semgrep"
                    class="tab-active px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all">
                <i class="fas fa-code"></i> Semgrep Code Analysis
                <span class="bg-white text-indigo-600 px-2 py-0.5 rounded-full text-sm font-bold">
                    {{ semgrep|length }}
                </span>
            </button>
            <button onclick="showTab('trivy')" id="tab-trivy"
                    class="tab-inactive px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all">
                <i class="fas fa-box"></i> Trivy Dependencies
                <span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-sm font-bold">
                    {{ trivy|length }}
                </span>
            </button>
            <button onclick="showTab('trufflehog')" id="tab-trufflehog"
                    class="tab-inactive px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all">
                <i class="fas fa-key"></i> TruffleHog Secrets
                <span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-sm font-bold">
                    {{ trufflehog|length }}
                </span>
            </button>
        </div>

        <!-- SEMGREP TAB -->
        <div id="content-semgrep">
            {% if semgrep %}
            <div class="mb-4 text-gray-600 font-semibold">
                <i class="fas fa-info-circle text-indigo-500 mr-1"></i>
                Showing {{ semgrep|length }} code vulnerabilities found by Semgrep
            </div>
            <div class="space-y-4">
                {% for f in semgrep %}
                <div class="card-hover bg-white rounded-2xl shadow-md p-6 border-l-4
                    {% if f.severity == 'ERROR' %}border-red-500
                    {% elif f.severity == 'WARNING' %}border-orange-400
                    {% else %}border-blue-400{% endif %}">

                    <!-- Header Row -->
                    <div class="flex items-start justify-between mb-4 flex-wrap gap-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="px-3 py-1 rounded-lg text-sm font-bold badge-{{ f.severity }}">
                                {% if f.severity == 'ERROR' %}üî¥ CRITICAL
                                {% elif f.severity == 'WARNING' %}üü† HIGH
                                {% else %}üîµ INFO{% endif %}
                            </span>
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-semibold">
                                {{ f.category }}
                            </span>
                        </div>
                        <span class="text-gray-400 text-sm font-mono">Finding #{{ loop.index }}</span>
                    </div>

                    <!-- Rule ID -->
                    <div class="mb-3 flex items-center gap-2 flex-wrap">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Rule:</span>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded text-indigo-700 break-all">{{ f.rule_id }}</code>
                    </div>

                    <!-- File & Line -->
                    <div class="flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-xl">
                        <i class="fas fa-file-code text-indigo-400"></i>
                        <code class="text-sm font-mono text-gray-700 break-all">{{ f.file }}</code>
                        <span class="ml-auto bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap">
                            Line {{ f.line }}
                        </span>
                    </div>

                    <!-- Issue -->
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-3">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-0.5 text-lg"></i>
                            <div>
                                <div class="font-bold text-red-700 mb-1">üö® Issue Found:</div>
                                <p class="text-red-800 text-sm">{{ f.message }}</p>
                                {% if f.cwe %}
                                <div class="mt-2 flex flex-wrap gap-1">
                                    {% for cwe in f.cwe %}
                                    <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">{{ cwe }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Fix -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-green-500 mt-0.5 text-lg"></i>
                            <div>
                                <div class="font-bold text-green-700 mb-1">‚úÖ How to Fix:</div>
                                <p class="text-green-800 text-sm">
                                    {% set rule = f.rule_id.lower() %}
                                    {% if 'sql' in rule %}
                                        Use parameterized queries: <code class="bg-green-200 px-1 rounded">cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))</code>
                                    {% elif 'eval' in rule %}
                                        Never use eval() on user input. Use <code class="bg-green-200 px-1 rounded">ast.literal_eval()</code> for safe parsing.
                                    {% elif 'command' in rule or 'os-system' in rule or 'subprocess' in rule %}
                                        Use subprocess with list args: <code class="bg-green-200 px-1 rounded">subprocess.run(['cmd', arg], capture_output=True)</code>
                                    {% elif 'secret' in rule or 'api-key' in rule or 'stripe' in rule or 'aws' in rule %}
                                        Move to environment variables: <code class="bg-green-200 px-1 rounded">os.getenv('API_KEY')</code> and add to <code class="bg-green-200 px-1 rounded">.env</code> file.
                                    {% elif 'path' in rule or 'traversal' in rule %}
                                        Validate paths: <code class="bg-green-200 px-1 rounded">os.path.realpath()</code> and check against allowed directories.
                                    {% elif 'xss' in rule or 'html' in rule or 'template' in rule %}
                                        Escape user input. Enable auto-escaping in your template engine.
                                    {% elif 'hash' in rule or 'md5' in rule or 'sha1' in rule %}
                                        Use strong hashing: <code class="bg-green-200 px-1 rounded">bcrypt</code> or <code class="bg-green-200 px-1 rounded">hashlib.sha256()</code>
                                    {% elif 'debug' in rule %}
                                        Set <code class="bg-green-200 px-1 rounded">debug=False</code> in production. Use environment variables to control this.
                                    {% else %}
                                        Review this security issue and follow OWASP best practices for {{ f.category }}.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white rounded-2xl shadow-md p-12 text-center">
                <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700">No Code Vulnerabilities!</h3>
                <p class="text-gray-500 mt-2">Semgrep found no issues in your code.</p>
            </div>
            {% endif %}
        </div>

        <!-- TRIVY TAB -->
        <div id="content-trivy" class="hidden">
            {% if trivy %}
            <div class="mb-4 text-gray-600 font-semibold">
                <i class="fas fa-info-circle text-indigo-500 mr-1"></i>
                Showing {{ trivy|length }} vulnerable dependencies found by Trivy
            </div>
            <div class="space-y-4">
                {% for v in trivy %}
                <div class="card-hover bg-white rounded-2xl shadow-md p-6 border-l-4
                    {% if v.severity == 'CRITICAL' %}border-red-500
                    {% elif v.severity == 'HIGH' %}border-orange-400
                    {% elif v.severity == 'MEDIUM' %}border-yellow-400
                    {% else %}border-green-400{% endif %}">

                    <!-- Header -->
                    <div class="flex items-start justify-between mb-4 flex-wrap gap-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="px-3 py-1 rounded-lg text-sm font-bold badge-{{ v.severity }}">
                                {% if v.severity == 'CRITICAL' %}üî¥ CRITICAL
                                {% elif v.severity == 'HIGH' %}üü† HIGH
                                {% elif v.severity == 'MEDIUM' %}üü° MEDIUM
                                {% else %}üü¢ LOW{% endif %}
                            </span>
                            <code class="text-sm bg-blue-50 text-blue-700 px-3 py-1 rounded-lg font-bold">
                                {{ v.cve_id }}
                            </code>
                        </div>
                        {% if v.url %}
                        <a href="{{ v.url }}" target="_blank"
                           class="text-indigo-500 hover:text-indigo-700 text-sm flex items-center gap-1">
                            <i class="fas fa-external-link-alt"></i> CVE Details
                        </a>
                        {% endif %}
                    </div>

                    <!-- Package Info -->
                    <div class="flex items-center gap-4 mb-4 p-3 bg-gray-50 rounded-xl flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-box text-indigo-400"></i>
                            <span class="font-bold text-gray-800 text-lg">{{ v.package }}</span>
                        </div>
                        <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-bold">
                            Installed: v{{ v.installed_version }}
                        </span>
                        {% if v.fixed_version %}
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">
                            Fixed: v{{ v.fixed_version }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Issue -->
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-3">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-0.5"></i>
                            <div>
                                <div class="font-bold text-red-700 mb-1">üö® Vulnerability:</div>
                                <p class="text-red-800 font-semibold">{{ v.title }}</p>
                                {% if v.description %}
                                <p class="text-red-700 text-sm mt-2">{{ v.description }}...</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Fix -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-tools text-green-500 mt-0.5"></i>
                            <div class="w-full">
                                <div class="font-bold text-green-700 mb-2">‚úÖ How to Fix:</div>
                                <p class="text-green-800 text-sm mb-2">
                                    Upgrade <strong>{{ v.package }}</strong> to version
                                    <code class="bg-green-200 px-2 py-0.5 rounded font-bold">{{ v.fixed_version if v.fixed_version else 'latest' }}</code>
                                </p>
                                <div class="bg-green-900 text-green-300 p-3 rounded-lg font-mono text-sm">
                                    pip install {{ v.package }}{% if v.fixed_version %}=={{ v.fixed_version.split(',')[0].strip() }}{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white rounded-2xl shadow-md p-12 text-center">
                <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700">No Vulnerable Dependencies!</h3>
                <p class="text-gray-500 mt-2">All packages are up to date.</p>
            </div>
            {% endif %}
        </div>

        <!-- TRUFFLEHOG TAB -->
        <div id="content-trufflehog" class="hidden">
            {% if trufflehog %}
            <div class="mb-4 text-gray-600 font-semibold">
                <i class="fas fa-info-circle text-indigo-500 mr-1"></i>
                Showing {{ trufflehog|length }} secrets/credentials detected by TruffleHog
            </div>
            <div class="space-y-4">
                {% for f in trufflehog %}
                <div class="card-hover bg-white rounded-2xl shadow-md p-6 border-l-4 border-red-500">

                    <div class="flex items-center gap-3 mb-4 flex-wrap">
                        <span class="px-3 py-1 bg-red-100 text-red-700 border border-red-300 rounded-lg text-sm font-bold">
                            üî¥ SECRET DETECTED
                        </span>
                        <span class="px-3 py-1 bg-purple-50 text-purple-700 rounded-lg text-sm font-bold">
                            üîë {{ f.reason }}
                        </span>
                    </div>

                    <!-- File Info -->
                    <div class="p-3 bg-gray-50 rounded-xl mb-4">
                        <div class="flex items-center gap-2 flex-wrap">
                            <i class="fas fa-file-code text-indigo-400"></i>
                            <code class="text-sm font-mono text-gray-700">{{ f.filepath }}</code>
                        </div>
                        <div class="flex gap-4 mt-2 text-xs text-gray-500 flex-wrap">
                            <span><i class="fas fa-code-branch mr-1"></i>{{ f.branch }}</span>
                            <span><i class="fas fa-calendar mr-1"></i>{{ f.date }}</span>
                        </div>
                    </div>

                    <!-- Issue -->
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-3">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-0.5 text-lg"></i>
                            <div>
                                <div class="font-bold text-red-700 mb-1">üö® Secret Exposed!</div>
                                <p class="text-red-800 text-sm">
                                    A <strong>{{ f.reason }}</strong> was found in <code class="bg-red-100 px-1 rounded">{{ f.filepath }}</code>.
                                    This secret could allow attackers to access your services!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Fix -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-lightbulb text-green-500 mt-0.5 text-lg"></i>
                            <div>
                                <div class="font-bold text-green-700 mb-2">‚úÖ How to Fix:</div>
                                <ol class="text-sm text-green-800 space-y-2 list-decimal ml-4">
                                    <li>üóëÔ∏è Remove the secret from <code class="bg-green-200 px-1 rounded">{{ f.filepath }}</code></li>
                                    <li>üìù Add it to <code class="bg-green-200 px-1 rounded">.env</code> file: <code class="bg-green-200 px-1 rounded">API_KEY=your_secret_here</code></li>
                                    <li>üö´ Add <code class="bg-green-200 px-1 rounded">.env</code> to <code class="bg-green-200 px-1 rounded">.gitignore</code></li>
                                    <li>üîÑ Use in code: <code class="bg-green-200 px-1 rounded">import os; key = os.getenv('API_KEY')</code></li>
                                    <li>üîÅ <strong class="text-red-700">Rotate this secret immediately!</strong> It may already be compromised.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white rounded-2xl shadow-md p-12 text-center">
                <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700">No Secrets Detected!</h3>
                <p class="text-gray-500 mt-2">No hardcoded credentials found.</p>
            </div>
            {% endif %}
        </div>

    </div>

    <footer class="text-center text-gray-400 py-8 border-t border-gray-200">
        <p class="font-semibold">SecureFlow v2.0 | Detailed Security Results</p>
    </footer>

    <script>
        function showTab(tab) {
            ['semgrep','trivy','trufflehog'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className =
                    'tab-inactive px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all';
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className =
                'tab-active px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all';
        }
    </script>

</body>
</html>
